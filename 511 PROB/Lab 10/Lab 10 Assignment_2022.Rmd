---
title: "Lab 10 Assignment"
author: "Dr. Purna Gamage"

output: rmdformats::robobook
---

## Problem 1-2 will be answered using the "Artists.csv"  data set.

### Please find the "Artists.csv"  data set in the Canvas-> Lab 10 folder.

Meanwhile, this is how you can retrieve Spotify Data:

Spotify’s API gives you the ability to extract several audio features of a song. The available features that also have been used for this analysis are: <https://medium.com/@boplantinga/what-do-spotifys-audio-features-tell-us-about-this-year-s-eurovision-song-contest-66ad188e112a>

The first step was registering my application in the API Website(<https://developer.spotify.com/documentation/web-api/>) and getting the keys (Client ID and Client Secret) for future requests. The Spotify Web API has different URIs (Uniform Resource Identifiers) to access playlists, artists, or tracks information. 

I extracted all the audio features for 3 musicians Taylor Swift, John Legend and Beyonce. But we are only going to use  selected features.

(If you like to use this data for your Final Project, you are more than welcome to :), but please extract more features from more musicians)

You can download the data set "Artists.csv" from Canvas->"Midterm" Folder.

```{r}
df <- read.csv('./Artists.csv')
```

## Problem 1: Hypothesis Testing - part 1 

Data Science Question: Is the average "speechiness" larger for Taylor Swift than that of John Legend ?

a. Perform EDA (Exploratory Data Analysis) using some Data Visualizations.

```{r}
library(ggplot2)
ggplot(data=df, aes(x=artist_name, y=speechiness, fill=artist_name)) +
  geom_boxplot()
```

b. Write the null and alternative hypothesis for this test.

Null hypothesis: The mean speechiness for Taylor Swift is equal to John Legend's.

Alternate: Swift's Legend's speechiness is > Legend's.

c. Perform a t-test and state your results and non-technical conclusion.

```{r}
set.seed(22)
speechT <- subset(df, select=speechiness,
                      subset=artist_name=="Taylor Swift", drop=T)

speechJ  <- subset(df, select=speechiness,
                      subset=artist_name=="John Legend", drop=T)

t.test(speechT, speechJ, alt="greater")
```

P-value of 0.025 with a 95% confidence interval between 0.003 and infinity.

There is sufficient evidence to conclude that Taylor Swift's average speechiness is greater than John Legend's speechiness.

d. What can you say about the confidence interval? (Interpret)

We are 95% confident that the difference of the means between Taylor Swift and john Lehend's speechiness will lie between 0.003 and infinity.

e. Perform a bootstrap test for ratio of means of "speechiness", Find the 95% bootstrap percentile interval for the ratio of means and write your conclusion. 
```{r}
set.seed(22)
# replicate the sampling 10000 times
boot.ts <- replicate(10000, mean(sample(speechT, length(speechT), replace = TRUE)))
boot.jl <- replicate(10000, mean(sample(speechJ, length(speechJ), replace = TRUE)))
# divide the vectors to get the ratio
boot.ratio <- boot.ts/boot.jl
# get the mean and sd of the ratio vector
mean.boot <- mean(boot.ratio)
sd.boot <- sd(boot.ratio)

rci <- mean.boot + 2*sd.boot
lci <- mean.boot - 2*sd.boot

paste0('We are 95% confident that the ratio of means between Taylors and Legends speechiness is between ', lci, ' and ', rci)
```

f. What is the bootstrap estimate of the bias for the mean ratio?

```{r}
real.bias <- mean(speechT)/mean(speechJ)
paste0('The bias for the mean ratio is:', mean.boot-real.bias)
```

g. Compare your results from part c) and part e).

Given that the mean speechiness of Swift and Legend are 0.11 and 0.095, respectively, we can see that the ratio of the mean between the two is about 1.2. Thanks to our calculations in part e, we can say with 95% confidence that said ratio will occur throughout the range of 0.98 and 1.44.


## Problem 2: Hypothesis Testing-part 2 

Data Science Question: Does "Valence" of the songs depends on the Artist?

Valence: A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry).

a. Create a new variable with the name " Valence_C" and add it to the "Artists" data set. Fill this variable with values "more positive","Moderate","more negative" according to the value of "Valence" such that 0.8-1 is "more positive", 0.5-0.79 is "Moderate" and 0.0-0.49 is "more negative".

```{r}
library(dplyr)
# creating the column based on cases
df <- df %>%
  mutate(Valence_C = case_when(
    Valence <= 0.49 ~ 'more negative',
    Valence <= 0.79 ~ 'Moderate',
    Valence > 0.8 ~ 'more positive')
  )
```

b. Carry out an appropriate test to make an informed decision for the above data science question using this new created variable  "Valence_C". Don't forget to Write the null and alternative hypothesis.

Null: Valence does not vary depending on artist. That is, all artists will have the same valence.

Alternate: Valence depends on the artist.

```{r}
tt <- table(df$artist_name, df$Valence_C)
# table with counts of valence for each artist
tt
# getting info needed for table of expected counts
r <- rowSums(tt)
c <- colSums(tt)
N = sum(tt)
# table with the expected counts of valence per artist
(expected <- round(outer(r,c)/N,2))
# test to see if null hypothesis holds
chisq.test(tt)
```

c. What is your conclusion?

Given that the p-value is less than 0.05, we have strong evidence that suggests we can reject the null hypothesis and that valence is dependent on the Artist.

d. With your experience, what is your opinion about the conclusion you made in part c?

The results make sense. Different artists will have different tones and themes in their music. Since Legend tends to sing about love and romance, his music tends to be down-beat and mellow, while Beyoncé tends to be closer to pop and her songs can be upbeat and energetic.

## Problem 3: Independence of Religion and View on Death Penalty.(Bonus 10)

Examine relation between "religion" and "views of the death penalty" using Chi square test.  Use gss2002 data.

```{r}
df <- read.csv('./GSS2002.csv')
```

a. Create a two-way table and examine the data.

```{r}
table <- table(df$Religion, df$DeathPenalty)
table
```

Examine: There's an imbalance in the data; favor has almost 150% more counts than oppose. Surprisingly, in almost every case, more people are in favor than against the death penalty.

b. Delete all rows with NAs for the two attributes. then create a new two way table with cleaned data.

```{r}
df.clean <- df[!is.na(df$Religion),]
df.clean <- df.clean[!is.na(df.clean$DeathPenalty),]
table.clean <- table(df.clean$Religion, df.clean$DeathPenalty)
table.clean
```

c. Write a function to calculate chi square statistic. Then calculate the chi square statistic for the table you created above.

```{r}
# using the function from the diary
chi = function(A){
  r <- rowSums(A)
  c <- colSums(A)
  N = sum(A)
  expected <- outer(r,c)/N
  return(sum((A-expected)^2/expected))
}

# chi square statistic
chi.stat = chi(table.clean)
chi.stat
# p value
pchisq(chi.stat, df=12, lower.tail = F)
```

d. Write a function to make random permutation, make table, and compute test statistic. Try it out for the cleaned data.

```{r}
set.seed(42)
# create a df with only the two columns we care about
df.clean2 <- df.clean %>% select(Religion, DeathPenalty)
chi2 = function(B){
  #perm <- B[sample(length(B$Religion), 1000, replace=FALSE),]
  B$Religion = B$Religion[sample(length(df.clean2$Religion),length(df.clean2$Religion),replace=F)] 
  perm.table <- table(B)
  return(chi(perm.table))
}
# testing the function
test.1 <- chi2(df.clean2)
test.1
```

e. Simulate null distribution (10000 simulations using the permutation function you used in part d). Plot the histogram of the null distribution and draw the red line where you observed the chi-square test statistic. 

```{r}
set.seed(42)
N = 10000
test.2 <- replicate(N, chi2(df.clean2))
hist(test.2)
abline(v = 18.1, col = 2, lwd = 2)
```

f. find the p-value. What is your Conclusion?

```{r}
mean(18.199<test.2)
```

Given that the p-value is not less than 0.05, we cannot reject the null hypothesis. Therefore, there is sufficient evidence to say that religion does have an effect on death penalty views.

g. Redo with chi squared test (use chisq.test()). Do you get the same conclusion?

```{r}
chisq.test(table.clean)
```

Although the p-value isn't exactly the same, it is almost identical, so we can reach the same conclusion as before.

## Problem 4: (Bonus 5 points)

Load the Verizon Data and examine the data (we have done this in last week lab)

```{r}
Verizon <- read.csv("Verizon.csv")
head(Verizon)
```


Examine the data

```{r}
table(Verizon$Group)
boxplot(Time ~ Group, data = Verizon)
boxplot(log10(Time) ~ Group, data = Verizon)
```

Means by customer group

```{r}
aggregate(Time ~ Group, data = Verizon, FUN = mean)
```


a. Make a function to compute the difference of two means. Using that function,calculate the _observed difference of means_.

 (Hint: Assume the data frame has the structure of the Verizon data and use the aggregate() function to calculate the means.)

```{r}
# creating the function
set.seed(42)
f.1 = function(C){
  df.1 <- aggregate(Time ~ Group, data = C, FUN = mean)
  return(df.1$Time[1]-df.1$Time[2])
}
# testing the function
test.1 <- f.1(Verizon)
test.1
```

b. Make a permutation of the labels and return the difference of means of the permuted data. (use the function that you created in part b)

```{r}
set.seed(123)
# permuting
ver.perm <- Verizon
ver.perm$Time = ver.perm$Time[sample(length(ver.perm$Time),length(ver.perm$Time),replace=F)] 
# calling the previous function on the permutation
f.1(ver.perm)
```

c. Repeat this many times(1000). Make histogram of the differences of means. Draw vertical line where the _observed difference of means_ (calculated this in part a) is.

```{r}
set.seed(42)
per.means <- c()
for(i in 1:1000){
  ver.perm <- Verizon
  ver.perm$Time = ver.perm$Time[sample(length(ver.perm$Time),length(ver.perm$Time),replace=F)]
  per.means <- c(per.means, f.1(ver.perm))
}
hist(per.means)
abline(v = 8.09, col = 2, lwd = 2)
```

d. Compute p-value

```{r}
mean(test.1<per.means)
```

e. Conclusion?

There is significant evidence to infer that the average time it takes to attend a Verizon vs Other client is not the same. Verizon has shorter wait times.



